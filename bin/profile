#!/usr/bin/env bash

sudo sysctl -w kernel.perf_event_paranoid=1
# sudo sysctl -w kernel.perf_event_mlock_kb=2048

sudo nvidia-smi -pm 1
sudo nvidia-smi --lock-gpu-clocks=2475
sudo nvidia-smi --lock-memory-clocks=9501

source $FLAKE_ROOT/.venv/bin/activate
# source $FLAKE_ROOT/mitsuba3/build-mitsuba/setpath.sh

perf record -o perf.data --call-graph dwarf -e cycles -m 128 --aio -z --sample-cpu source $FLAKE_ROOT/.venv/bin/activate && $@

sudo nvidia-smi --reset-gpu-clocks; sudo nvidia-smi --reset-memory-clocks
